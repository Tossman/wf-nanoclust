//
// wf-nanoclust Nextflow config file
// EPI2ME Compatible Configuration
//

// Global default parameters
params {
    help = false
    version = false

    // ==================
    // Input/Output Options
    // ==================
    fastq = null
    bam = null
    out_dir = "output"
    sample = null
    sample_sheet = null
    analyse_unclassified = false

    // ==================
    // Read Filtering
    // ==================
    min_read_length = 1400
    max_read_length = 1700
    min_read_quality = 8

    // ==================
    // Clustering Parameters
    // ==================
    umap_set_size = 100000
    cluster_sel_epsilon = 0.5
    min_cluster_size = 50

    // ==================
    // Polishing Parameters
    // ==================
    polishing_reads = 100

    // ==================
    // Classification
    // ==================
    database = null
    taxonomy = null

    // ==================
    // Resource Limits
    // ==================
    threads = 4
    max_cpus = 16
    max_memory = "32.GB"
    max_time = "24.h"

    // ==================
    // Report Options
    // ==================
    disable_ping = false

    // ==================
    // Advanced Options
    // ==================
    process_label = "wfnanoclust"
    monochrome_logs = false
    validate_params = true
    show_hidden_params = false
    schema_ignore_params = 'show_hidden_params,validate_params,monochrome_logs,aws_queue,aws_image_prefix,wf'

    // ==================
    // EPI2ME Workflow Options
    // ==================
    wf {
        name = "wf-nanoclust"
        template_version = "v1.0.0"
        example_cmd = [
            "--fastq test_data/",
            "--database data/16S_ribosomal_RNA",
            "--taxonomy data/taxdb"
        ]
        agent = null
        container_sha = null
        common_sha = null
    }
}

// ==================
// Manifest
// ==================
manifest {
    name            = 'Tossman/wf-nanoclust'
    author          = 'Tossman'
    homePage        = 'https://github.com/Tossman/wf-nanoclust'
    description     = 'De novo clustering and consensus building for 16S/18S rRNA amplicons from Oxford Nanopore sequencing'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04.2'
    version         = 'v1.0.0'
}

// ==================
// EPI2ME Labs Metadata
// ==================
epi2melabs {
    tags = 'amplicon,16S,18S,metagenomics,clustering,denovo,microbiome'
    icon = 'faDna'
}

// ==================
// Environment
// ==================
env {
    PYTHONNOUSERSITE = 1
    JAVA_TOOL_OPTIONS = "-Xlog:disable -Xlog:all=warning:stderr"
}

// ==================
// Process Configuration
// ==================
process {
    errorStrategy = 'retry'
    maxRetries = 2
    
    withLabel: 'wfnanoclust' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withLabel: 'process_low' {
        cpus = 2
        memory = { 4.GB * task.attempt }
        time = '4h'
    }
    
    withLabel: 'process_medium' {
        cpus = { 4 * task.attempt }
        memory = { 8.GB * task.attempt }
        time = '8h'
    }
    
    withLabel: 'process_high' {
        cpus = { 8 * task.attempt }
        memory = { 32.GB * task.attempt }
        time = '16h'
    }
    
    withLabel: 'process_clustering' {
        cpus = 4
        memory = { 32.GB * task.attempt }
        time = '12h'
    }
    
    withLabel: 'process_polishing' {
        cpus = 4
        memory = { 16.GB * task.attempt }
        time = '8h'
    }

    // Module-specific containers
    withName: 'QC_FILTER' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'KMER_FREQS' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'READ_CLUSTERING' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
        memory = { 32.GB * task.attempt }
    }
    
    withName: 'SPLIT_BY_CLUSTER' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'READ_CORRECTION' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'DRAFT_SELECTION' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'RACON_PASS' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'MEDAKA_PASS' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'CONSENSUS_CLASSIFICATION' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'GET_ABUNDANCES' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'PLOT_ABUNDANCES' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
    
    withName: 'MAKE_REPORT' {
        container = 'ontresearch/wf-nanoclust:v1.0.0'
    }
}

// ==================
// Profiles
// ==================
profiles {
    standard {
        docker {
            enabled = true
            runOptions = '--user $(id -u):$(id -g)'
        }
    }

    singularity {
        singularity {
            enabled = true
            autoMounts = true
        }
    }
    
    conda {
        conda.enabled = true
    }

    // Test profile with minimal resources
    test {
        params {
            fastq = "${projectDir}/test_data"
            database = "${projectDir}/data/16S_ribosomal_RNA"
            taxonomy = "${projectDir}/data/taxdb"
            umap_set_size = 5000
            min_cluster_size = 20
            polishing_reads = 20
            out_dir = "test_output"
        }
    }

    // Low memory profile
    low_memory {
        params {
            umap_set_size = 25000
            polishing_reads = 50
            max_memory = "16.GB"
            max_cpus = 4
        }
        process {
            memory = { 8.GB * task.attempt }
        }
    }

    // High resolution profile for complex samples
    high_resolution {
        params {
            umap_set_size = 100000
            cluster_sel_epsilon = 0.3
            min_cluster_size = 30
            polishing_reads = 200
            max_memory = "64.GB"
        }
    }

    // 18S profile
    profile_18S {
        params {
            min_read_length = 1700
            max_read_length = 2100
        }
    }
}

// ==================
// Execution Reports
// ==================
timeline {
    enabled = true
    file = "${params.out_dir}/execution/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file = "${params.out_dir}/execution/report.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.out_dir}/execution/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.out_dir}/execution/dag.html"
    overwrite = true
}
